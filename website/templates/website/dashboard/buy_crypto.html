{% extends "website/dashboard/base.html" %}

{% block title %}Acheter des cryptos – EasyPass{% endblock %}
{% block page_title %}Acheter des cryptos{% endblock %}

{% block content %}
{% if success %}
<!-- Success Page -->
<div id="successPage" class="w-full bg-white rounded-xl shadow p-6 sm:p-8 text-center">
    <h3 class="text-lg sm:text-xl font-bold text-green-900 mb-6">
        Achat réussi !
    </h3>
    <p class="text-sm text-gray-700 mb-6">
        Merci pour votre achat.<br>
        
        {% if contact_method == "email" %}
            Veuillez consulter votre <span class="font-bold">boîte e-mail</span> à l’adresse 
            <span class="font-bold">{{ final_email }}</span> pour les instructions de paiement.
        {% elif contact_method == "whatsapp" %}
            Veuillez consulter votre <span class="font-bold">téléphone (WhatsApp)</span> au numéro 
            <span class="font-bold">{{ whatsapp_number }}</span> pour les instructions de paiement.

            <p>Des Troubles? Contactez notre service a la clientele au <span class="font-bold">+50940038603</span></p>
        {% endif %}
    </p>

    <!-- Action Buttons -->
    <div class="flex justify-center gap-4 mt-6">
        <a href="{% url 'website:buy' %}" 
           class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-bold">
            Acheter à nouveau
        </a>
        <a href="{% url 'website:dashboard' %}" 
           class="bg-green-700 hover:bg-gray-800 text-white py-2 px-4 rounded-lg font-bold">
            Aller au tableau de bord
        </a>
    </div>
</div>
{% else %}
<!-- Buy Page -->
<div id="buyPage" class="w-full bg-white rounded-xl shadow p-6 sm:p-8">
    <h3 class="text-lg sm:text-xl font-bold text-blue-900 mb-6">
        Acheter des cryptomonnaies
    </h3>

    {% if error %}
    <div class="bg-red-100 text-red-700 p-3 rounded mb-4">
        {{ error }}
    </div>
    {% endif %}

    <form method="post" id="buyForm">
        {% csrf_token %}
        <div class="space-y-4">
            <input type="number" step="0.01" name="usd_amount" id="usd_amount" placeholder="Entrez le montant en USD"
                   class="w-full border rounded-lg p-3" required>

            <select name="crypto" id="crypto" class="w-full border rounded-lg p-3" required>
                <option value="bitcoin">Bitcoin (BTC)</option>
                <option value="ethereum">Ethereum (ETH)</option>
                <option value="litecoin">Litecoin (LTC)</option>
                <option value="dogecoin">Dogecoin (DOGE)</option>
                <option value="solana">Solana (SOL)</option>
                <option value="tether">Tether (USDT)</option>
            </select>

            <button type="button" id="calculateBtn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition">
                Obtenir un devis
            </button>
        </div>

        <!-- Result -->
        <div id="result" class="mt-6 p-4 bg-blue-100 rounded-lg hidden"></div>

        <!-- Contact Method -->
        <div id="contactSection" class="mt-6 hidden">
            <label for="contact_method">Méthode de contact préférée :</label>
            <select name="contact_method" id="contact_method" class="w-full border rounded-lg p-3" required>
                
                <option value="whatsapp">WhatsApp</option>
            </select>

            <!-- Email Field -->
            <div id="emailField" class="mt-4 hidden">
                <label for="contact_email">Adresse e-mail :</label>
                <input type="email" name="contact_email" id="contact_email"
                    class="w-full border rounded-lg p-3"
                    value="{{ request.user.email }}"
                    placeholder="vous@exemple.com">

                <label for="new_contact_email" class="mt-2 block text-sm text-gray-600">
                    Ajouter une autre adresse e-mail (optionnel) :
                </label>
                <input type="email" name="new_contact_email" id="new_contact_email"
                    class="w-full border rounded-lg p-3"
                    placeholder="Entrez une nouvelle adresse e-mail si vous le souhaitez">
            </div>

            <!-- WhatsApp Field -->
            <div id="whatsappField" class="mt-4 hidden">
                <label for="whatsapp_number">Numéro WhatsApp :</label>
                <input type="text" name="whatsapp_number" id="whatsapp_number"
                    class="w-full border rounded-lg p-3" placeholder="+33XXXXXXXXX">
            </div>

            <!-- Crypto Address Field -->
            <div id="cryptoAddressField" class="mt-4">
                <label for="crypto_address">Adresse du portefeuille : (Ajoutez l’adresse à laquelle vous souhaitez recevoir vos cryptos)</label>
                <input type="text" name="crypto_address" id="crypto_address"
                    class="w-full border rounded-lg p-3" placeholder="Entrez l’adresse de votre portefeuille" required>
            </div>
        </div>

        <!-- Buy Button -->
        <div id="buySection" class="mt-6 hidden">
            <button type="submit" id="buyBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold transition">
                Acheter maintenant
            </button>
        </div>
    </form>
</div>
{% endif %}

<script>
async function getCryptoPrice(crypto) {
    const url = `https://api.coingecko.com/api/v3/simple/price?ids=${crypto}&vs_currencies=usd`;
    const response = await fetch(url);
    const data = await response.json();
    return data[crypto].usd;
}

function toggleContactFields() {
    const method = document.getElementById("contact_method").value;

    if (method === "whatsapp") {
        document.getElementById("whatsappField").classList.remove("hidden");
        document.getElementById("emailField").classList.add("hidden");
    } else {
        document.getElementById("emailField").classList.remove("hidden");
        document.getElementById("whatsappField").classList.add("hidden");
    }
}

document.getElementById("calculateBtn")?.addEventListener("click", async () => {
    const usdAmount = parseFloat(document.getElementById("usd_amount").value);
    const crypto = document.getElementById("crypto").value;

    if (!usdAmount || usdAmount < 10) {
        alert("Le montant minimum d’achat est de 10 $. Veuillez ajuster le montant.");
        return;
    }

    try {
        const price = await getCryptoPrice(crypto);
        const fee = 6;
        const total = usdAmount + fee;
        const cryptoAmount = usdAmount / price;

        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = `
            <p class="font-bold text-blue-900">
                Montant saisi : $${usdAmount.toFixed(2)} <br>
                Frais : $${fee.toFixed(2)} <br>
                Total : $${total.toFixed(2)} <br><br>
                Vous recevrez : ${cryptoAmount.toFixed(6)} ${crypto.toUpperCase()}
            </p>
            <p class="text-sm text-gray-700">
                Prix actuel : $${price}
            </p>
        `;
        resultDiv.classList.remove("hidden");

        document.getElementById("contactSection").classList.remove("hidden");
        document.getElementById("buySection").classList.remove("hidden");

        // ✅ IMPORTANT: force correct field display
        toggleContactFields();

    } catch (error) {
        alert("Erreur lors de la récupération du prix. Veuillez réessayer.");
        console.error(error);
    }
});

document.getElementById("contact_method")?.addEventListener("change", toggleContactFields);
</script>
{% endblock %}